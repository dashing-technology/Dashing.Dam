<%@ Master Language="C#" AutoEventWireup="true" CodeBehind="ThemedPage.master.cs" Inherits="uStore.PageLayout.ThemedPage" %>
<%@ Register TagPrefix="uStore" TagName="MetaTags" Src="~/UControls/MetaTags.ascx" %>
<%@ Register TagPrefix="uStore" TagName="WebEnhancerButton" Src="~/UControls/WebEnhancerButton.ascx" %>
<%@ Import namespace="System.Data.SqlClient" %>
<%@ Import Namespace="System.Data" %>
<%@ Import Namespace="System.Net" %>
<%@ Import Namespace="System.Web.Script.Serialization" %>
<%@ Import Namespace="System.Web" %>
<%@ Import Namespace="System.IO" %>
<%@ Import Namespace="System.Collections" %>
<%@ Import Namespace="Microsoft.Practices.EnterpriseLibrary.Caching" %>

<script runat="server">
    string debug = "";
    string newProductGroupID = "";
    string newProductDesc = "";
    string dbRedirectUrl = "";



    protected void Page_Load(object sender, EventArgs e)
    {
        if ( this.isAdmin() )
        {
            string operation = (string)Request["operation"] ?? String.Empty;

            if(operation == "addDropBocFileDesc")
            {
                string fileName = (string)Request["fileName"] ?? String.Empty;
                string catId = (string)Request["catId"] ?? String.Empty;
                string fileDesc = (string)Request["fileDesc"] ?? String.Empty;
                fileDesc = fileDesc.Replace("'","''");

                if(fileName != "" && catId != "" && fileDesc != "")
                {
                    String query = "EXEC [GLD-Xmpie-EXT].[dbo].[addDropBocFileDesc] @fileName = '"+fileName+"', @catId = "+catId+", @fileDesc = '"+fileDesc+"'";
                    List<Object[]> result = this.DBQuery(query);
                }
            }
            else if(operation == "updateDropBoxFileDesc")
            {
                string fileName = (string)Request["fileName"] ?? String.Empty;
                string catId = (string)Request["catId"] ?? String.Empty;
                string fileDesc = (string)Request["fileDesc"] ?? String.Empty;
                string dropBoxFileDescId = (string)Request["dropBoxFileDescId"] ?? String.Empty;
                fileDesc = fileDesc.Replace("'","''");

                if(fileName != "" && catId != "" && fileDesc != "" && dropBoxFileDescId != "")
                {
                    String query = "EXEC [GLD-Xmpie-EXT].[dbo].[updateDropBoxDesc] @fileName = '"+fileName+"', @catId = "+catId+", @fileDesc = '"+fileDesc+"', @dropBoxFileDescId = "+dropBoxFileDescId;
                    List<Object[]> result = this.DBQuery(query);
                }
            }
            else if(operation == "removeDropBoxDesc")
            {
                string dropBoxFileDescId = (string)Request["dropBoxFileDescId"] ?? String.Empty;

                if(dropBoxFileDescId != "")
                {
                    String query = "EXEC [GLD-Xmpie-EXT].[dbo].[removeDropBoxDesc] @dropBoxFileDescId = "+dropBoxFileDescId;
                    List<Object[]> result = this.DBQuery(query);
                }
            }
            else if(operation == "addNewCat")
            {
                string dropBoxPath = (string)Request["dropBoxPath"] ?? String.Empty;
                string ParentGroupID = (string)Request["ParentGroupID"] ?? String.Empty;
                string NamePG = (string)Request["NamePG"] ?? String.Empty;
                NamePG = NamePG.Replace("'", "''");

                String endpoint = "http://119.9.18.209/drop-box-php/addFolder.php?tk=d098lkLKHJg903kjh3liO78Go2s0987sgd8gq1IUY21kI9g&path="+dropBoxPath;

                dynamic dbApiResult = this.XMPQuery(endpoint);
                bool isError = dbApiResult.ContainsKey("ERROR");
                dropBoxPath = dropBoxPath.Replace("'", "''");
                if(!isError)
                {
                    String query = "EXECUTE [GLD-Xmpie-EXT].[dbo].[addDropBoxPathToUstore] @StoreID=144,@ParentGroupID="+ParentGroupID+",@NamePG='"+NamePG+"',@DescriptionSEO='"+dropBoxPath+"',@ProductID=6719";
                    List<Object[]> result = this.DBQuery(query);

                    if( result.Count >= 0 )
                    {

                        foreach (var objres in result)
                        {

                            if(objres.Length > 0)
                            {
                                newProductGroupID = objres[0].ToString();
                                newProductDesc = objres[1].ToString();
                                hdnMenuUrl.Value = @"http://eezeeorder.com.au/uStore/144/Category/" + newProductGroupID + "/" + newProductDesc;
                                dbRedirectUrl = hdnMenuUrl.Value;
                                using (System.IO.StreamWriter w = File.AppendText("C:\\Temp\\Log\\Log.txt"))
                                {
                                    Log(objres[0].ToString() + " " + objres[1].ToString(), w);

                                    Log(hdnMenuUrl.Value, w);
                                }

                            }
                        }
                    }
                }

                //return ParentGroupID + "/" NamePG.Replace("''", "-");
            }
            else if(operation == "renameCat")
            {
                string dropBoxPath = (string)Request["dropBoxPath"] ?? String.Empty;
                string newDropBoxPath = (string)Request["newDropBoxPath"] ?? String.Empty;
                string ProductGroupID = (string)Request["ProductGroupID"] ?? String.Empty;
                string NamePG = (string)Request["NamePG"] ?? String.Empty;

                String endpoint = "http://119.9.18.209/drop-box-php/renameFile.php?tk=d098lkLKHJg903kjh3liO78Go2s0987sgd8gq1IUY21kI9g&path="+dropBoxPath+"&newPath="+newDropBoxPath;

                dynamic dbApiResult = this.XMPQuery(endpoint);
                bool isError = dbApiResult.ContainsKey("ERROR");

                if(!isError)
                {
                    NamePG = NamePG.Replace("'", "''");
                    dropBoxPath = dropBoxPath.Replace("'", "''");
                    newDropBoxPath = newDropBoxPath.Replace("'", "''");

                    List<Object[]> prodGroups = this.DBQuery("SELECT PG.ProductGroupID,StoreID,Description,CampaignID,DisplayOrder,ModifiedLoginSessionID,ModifiedDate,StatusID,CustomHeaderUrl,ParentGroupID,ProductGroupType FROM ProductGroup PG LEFT JOIN ProductGroup_Culture PGC ON PGC.ProductGroupID = PG.ProductGroupID AND PGC.CultureID=5001 WHERE PG.ProductGroupID = "+ProductGroupID);

                    if( prodGroups.Count > 0 )
                    {
                        foreach (var prodGroup in prodGroups)
                        {
                            int StoreID = (int)prodGroup[1];
                            string Description = (string)prodGroup[2];
                            int DisplayOrder = (int)prodGroup[4];
                            int ModifiedLoginSessionID = (int)prodGroup[5];
                            int StatusID = (int)prodGroup[7];
                            string CustomHeaderUrl = (string)prodGroup[8];
                            int ParentGroupID = (int)prodGroup[9];
                            int ProductGroupType = (int)prodGroup[10];

                            Description = Description.Replace("'", "''");

                            String queryPG = "EXECUTE [uStore].[dbo].[ProductGroup_Update] @ProductGroupID = "+ProductGroupID+" ,@StoreID = "+StoreID+" ,@Name = '"+NamePG+"' ,@Description = '"+Description+"' ,@CampaignID = null ,@DisplayOrder = "+DisplayOrder+" ,@ModifiedLoginSessionID = "+ModifiedLoginSessionID+" ,@StatusID = "+StatusID+" ,@CustomHeaderUrl = '"+CustomHeaderUrl+"' ,@ParentGroupID = "+ParentGroupID+" ,@ProductGroupType = "+ProductGroupType;
                            this.DBQuery(queryPG);

                            List<Object[]> seoCntnRecs = this.DBQuery("SELECT S.SEOContentID , EntityTypeID , EntityID , CultureID , Title , Description , Keywords , TitleAddition , TitleAdditionFormatID FROM SEOContent S JOIN SEOContent_Culture SC ON SC.SEOContentID = S.SEOContentID WHERE S.EntityTypeID = 2 AND S.EntityID = "+ProductGroupID+" AND SC.CultureID = 5001");

                            if( seoCntnRecs.Count > 0 )
                            {
                                foreach (var seoCntnRec in seoCntnRecs)
                                {
                                    int SEOContentID = (int)seoCntnRec[0];
                                    int EntityTypeID = (int)seoCntnRec[1];
                                    int EntityID = (int)seoCntnRec[2];
                                    int CultureID = (int)seoCntnRec[3];
                                    string Title = (string)seoCntnRec[4];
                                    string DescriptionSEO = newDropBoxPath;
                                    string Keywords = (string)seoCntnRec[6];
                                    string TitleAddition = (string)seoCntnRec[7];
                                    int TitleAdditionFormatID = (int)seoCntnRec[8];

                                    String querySEO = "EXECUTE [uStore].[dbo].[SEOContent_Update]  @SEOContentID = "+SEOContentID+" ,@EntityTypeID = "+EntityTypeID+" ,@EntityID = "+EntityID+" ,@CultureID = "+CultureID+" ,@Title = '"+Title+"'  ,@Description =' "+DescriptionSEO+"' ,@Keywords = '"+Keywords+"' ,@TitleAddition = '"+TitleAddition+"' ,@TitleAdditionFormatID = "+TitleAdditionFormatID;
                                    this.DBQuery(querySEO);

                                    break;
                                }
                            }

                            List<Object[]> seoCntnRecsChildren = this.DBQuery("SELECT [SEOContent_Culture].[Description],[SEOContentCultureID] FROM [uStore].[dbo].[SEOContent_Culture] WHERE Description LIKE '%"+dropBoxPath+"%'");

                            if( seoCntnRecsChildren.Count > 0 )
                            {
                                foreach (var seoCntnRecsChild in seoCntnRecsChildren)
                                {
                                    string DescriptionSEOChild = (string)seoCntnRecsChild[0];
                                    int SEOContentCultureIDChild = (int)seoCntnRecsChild[1];

                                    DescriptionSEOChild = DescriptionSEOChild.Replace(dropBoxPath,newDropBoxPath+"/");

                                    String querySEOChild = "UPDATE [uStore].[dbo].[SEOContent_Culture] SET [Description] = '"+DescriptionSEOChild+"' WHERE [SEOContent_Culture].[SEOContentCultureID] = "+SEOContentCultureIDChild;
                                    this.DBQuery(querySEOChild);

                                    break;
                                }
                            }

                            break;
                        }
                    }
                }
            }
            else if(operation == "removeCat")
            {
                string dropBoxPath = (string)Request["dropBoxPath"] ?? String.Empty;
                string ProductGroupID = (string)Request["ProductGroupID"] ?? String.Empty;
                dbRedirectUrl = (string)Request["parentUrl"] ?? String.Empty;

                String endpoint = "http://119.9.18.209/drop-box-php/removeFile.php?tk=d098lkLKHJg903kjh3liO78Go2s0987sgd8gq1IUY21kI9g&path="+dropBoxPath;

                dynamic dbApiResult = this.XMPQuery(endpoint);
                bool isError = dbApiResult.ContainsKey("ERROR");

                if(!isError)
                {
                    List<int> terminalPids = new List<int>();
                    terminalPids.Add( Int32.Parse(ProductGroupID) );

                    foreach (var terminalPid in terminalPids)
                    {
                        String queryPGMem = "DELETE FROM [uStore].[dbo].[ProductGroupMembership] WHERE ProductGroupID = "+terminalPid;
                        this.DBQuery(queryPGMem);

                        String queryPG = "EXECUTE [uStore].[dbo].[ProductGroup_Delete] @ProductGroupID = "+terminalPid;
                        this.DBQuery(queryPG);

                        List<Object[]> seoCntnRecs = this.DBQuery("SELECT S.SEOContentID , EntityTypeID , EntityID , CultureID , Title , Description , Keywords , TitleAddition , TitleAdditionFormatID FROM SEOContent S JOIN SEOContent_Culture SC ON SC.SEOContentID = S.SEOContentID WHERE S.EntityTypeID = 2 AND S.EntityID = "+terminalPid+" AND SC.CultureID = 5001");

                        if( seoCntnRecs.Count > 0 )
                        {
                            foreach (var seoCntnRec in seoCntnRecs)
                            {
                                int SEOContentID = (int)seoCntnRec[0];

                                String querySEO = "EXECUTE [uStore].[dbo].[SEOContent_Delete] @SEOContentID = "+SEOContentID;
                                this.DBQuery(querySEO);

                                break;
                            }
                        }
                    }
                }
            }
            else if(operation == "renameFile")
            {
                string dropBoxPath = (string)Request["dropBoxPath"] ?? String.Empty;
                string newDropBoxPath = (string)Request["newDropBoxPath"] ?? String.Empty;
                string NamePG = (string)Request["NamePG"] ?? String.Empty;

                String endpoint = "http://119.9.18.209/drop-box-php/renameFile.php?tk=d098lkLKHJg903kjh3liO78Go2s0987sgd8gq1IUY21kI9g&path="+dropBoxPath+"&newPath="+newDropBoxPath;

                dynamic dbApiResult = this.XMPQuery(endpoint);
            }
            else if(operation == "deleteFile")
            {
                string dropBoxPath = (string)Request["dropBoxPath"] ?? String.Empty;
                string ProductGroupID = (string)Request["ProductGroupID"] ?? String.Empty;
                string fileName = (string)Request["FileName"] ?? String.Empty;

                if(fileName.Length > 0)
                {
                    string querySEO = "DELETE FROM [GLD-Xmpie-EXT].[dbo].[DropBox-File-Desc] WHERE  catID= "+ProductGroupID + " AND fileName='" + fileName+ "'";
                    this.DBQuery(querySEO);
                }

                String endpoint = "http://119.9.18.209/drop-box-php/removeFile.php?tk=d098lkLKHJg903kjh3liO78Go2s0987sgd8gq1IUY21kI9g&path="+dropBoxPath;

                dynamic dbApiResult = this.XMPQuery(endpoint);
            }
            CacheFactory.GetCacheManager("GeneralCacheManager").Flush();
        }
    }

    public void Log(string logMessage, System.IO.TextWriter w)
    {
        w.Write("\r\nLog Entry : ");
        w.WriteLine("{0} {1}", DateTime.Now.ToLongTimeString(),
            DateTime.Now.ToLongDateString());
        w.WriteLine("  :");
        w.WriteLine("  :{0}", logMessage);
        w.WriteLine ("-------------------------------");
    }

    public bool isAdmin()
    {
        bool isAdmin = false;

        dynamic UserGroupsByUser = null;

        dynamic uGroupIds = null;

        try
        {
            UserGroupsByUser = uStoreAPI.UserGroup.GetUserGroupList(uStore.Common.BLL.CustomerInfo.Current.UserID);

            foreach(uStoreAPI.UserGroup UG in UserGroupsByUser)
            {
                if(UG.UserGroupID == 10530
                || UG.UserGroupID == 10905
                || UG.UserGroupID == 10510
                || UG.UserGroupID == 10511
                || UG.UserGroupID == 10906
                || UG.UserGroupID == 10509
                || UG.UserGroupID == 10903
                || UG.UserGroupID == 10900
                || UG.UserGroupID == 10901
                || UG.UserGroupID == 10902
                || UG.UserGroupID == 10905
                || UG.UserGroupID == 10904
                || UG.UserGroupID == 10836
                || UG.UserGroupID == 10854
                || UG.UserGroupID == 10837
                || UG.UserGroupID == 10908
                || UG.UserGroupID == 10845
                || UG.UserGroupID == 10852
                || UG.UserGroupID == 10846
                || UG.UserGroupID == 10844
                || UG.UserGroupID == 10838
                || UG.UserGroupID == 10839
                || UG.UserGroupID == 10853
                || UG.UserGroupID == 10840
                || UG.UserGroupID == 10907
                || UG.UserGroupID == 10841
                )
                    isAdmin = true;
            }
        }
        catch(Exception e){}

        return isAdmin;
    }

    public bool isSuperAdmin()
    {
        bool isAdmin = false;

        dynamic UserGroupsByUser = null;

        dynamic uGroupIds = null;

        try
        {
            UserGroupsByUser = uStoreAPI.UserGroup.GetUserGroupList(uStore.Common.BLL.CustomerInfo.Current.UserID);

            foreach(uStoreAPI.UserGroup UG in UserGroupsByUser)
            {
                if(UG.UserGroupID == 10530
                || UG.UserGroupID == 10906
                || UG.UserGroupID == 10905)
                    isAdmin = true;
            }
        }
        catch(Exception e){}

        return isAdmin;
    }

    public List<Object[]> DBQuery(String sqlQuery)
    {
        SqlConnection sqlConnection1 = new SqlConnection("server=556627-SQL1;database=uStore;Pooling=True;uid=sa;pwd=4P3Jh7MZP4Gj;");
        SqlCommand cmd = new SqlCommand();
        SqlDataReader reader;

        cmd.CommandText = sqlQuery;
        cmd.CommandType = CommandType.Text;
        cmd.Connection = sqlConnection1;

        sqlConnection1.Open();

        reader = cmd.ExecuteReader();
        List<Object[]>  rows = new List<Object[]>();
        while (reader.Read())
        {
            Object[] values = new Object[reader.FieldCount];
            int fieldCount = reader.GetValues(values);

            rows.Add(values);
        }

        sqlConnection1.Close();
        return rows;
    }

    public dynamic XMPQuery(String endpoint)
    {
        using (var client = new WebClient())
        {
            var contents = client.DownloadString(endpoint);
            JavaScriptSerializer javaScriptSerializer = new JavaScriptSerializer();

            return javaScriptSerializer.Deserialize<dynamic>(contents);
        }
    }

    public bool isSearchPage
    {
        get
        {
            if( this.Page.Request.FilePath.IndexOf("/uStore/144/Search") > -1  )
            {
                return true;
            }

            return false;

        }
    }
</script>
<!doctype html>
<html>
<head>
    <uStore:MetaTags ID="MetaTags" runat="server" />
    <link href="<%= DefaultStylePath %>" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="<%= StoreStyle %>" type="text/css" />
    <link rel="stylesheet" href="<%= StoreStylePath %>RadSkins/Default/Grid.Default.css" type="text/css" />
    <link rel="stylesheet" href="<%= StoreStylePath %>RadSkins/Default/TreeView.Default.css" type="text/css" />
    <link rel="stylesheet" href="<%= StoreStylePath %>RadSkins/Default/Calendar.Default.css" type="text/css" />
    <link rel="stylesheet" href="<%= StoreStylePath %>RadSkins/Default/Menu.Default.css" type="text/css" />
    <link rel="stylesheet" href="<%= StorejQueryStyle %>" type="text/css" />
    <asp:ContentPlaceHolder ID="cphHtmlHeader" runat="server"></asp:ContentPlaceHolder>
    <%

    if ( this.isAdmin() )
    { %>
    <link href="<%= StoreStylePath %>jq-context-menu/jquery.contextMenu.min.css" rel="stylesheet" type="text/css" />
    <% } %>
</head>
<body>
    <asp:PlaceHolder ID="plhWaitingDiv" runat="server"></asp:PlaceHolder>
    <script type="text/javascript" src="<%= ScriptsPath %>"></script>
    <form id="form1" runat="server">
        <asp:ScriptManager ID="scriptManager" runat="server" EnablePageMethods="true"></asp:ScriptManager>
        <uStore:WebEnhancerButton ID="WebEnhancerButton" runat="server" />
        <div id="fullpage" class="ThemedPageMaster">
            <div id="logo"></div>

            <asp:ContentPlaceHolder ID="cphStandardHeader" runat="server"></asp:ContentPlaceHolder>

            <asp:ContentPlaceHolder ID="cphWelcome" runat="server"></asp:ContentPlaceHolder>

            <asp:ContentPlaceHolder ID="cphFlags" runat="server"></asp:ContentPlaceHolder>

            <asp:ContentPlaceHolder ID="cphCurrency" runat="server"></asp:ContentPlaceHolder>

            <asp:ContentPlaceHolder ID="cphCustomHeader" runat="server"></asp:ContentPlaceHolder>

            <div id="searcharea">
                <div class="subtitle">
                    <%= PageSubTitle %>
                </div>
                <asp:ContentPlaceHolder ID="cphProductSearch" runat="server"></asp:ContentPlaceHolder>
            </div>

            <!-- Body Area Start -->
            <div id="bodyarea">

                <div id="navArea">
                    <!-- Navigation Area Start -->
                    <asp:ContentPlaceHolder ID="cphProductGroups" runat="server"></asp:ContentPlaceHolder>
                </div>
                <div id="contentArea">

                    <!-- Content Area Start -->
                    <div id="content">
                        <div class="mainarea">
                            <asp:ContentPlaceHolder ID="cphMainContent" runat="server"></asp:ContentPlaceHolder>
                        </div>
                        <div class="mainAreaFooter">
                            <asp:ContentPlaceHolder ID="cphMainContentFooter" runat="server"></asp:ContentPlaceHolder>
                        </div>
                        <div id="hiddenarea">
                            <input type="hidden" id="hdnMenuUrl" name="hdnMenuUrl" runat="server" ClientIDMode="Static" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Area Start -->
            <div id="masterPageFooter" class="clearfloat"></div>
            <asp:ContentPlaceHolder ID="cphCustomFooter" runat="server"></asp:ContentPlaceHolder>
            <div id="postFooter"></div>

        </div>
    </form>
    <script type="text/javascript">

        var home_link = document.createElement('a');
        home_link.setAttribute('href', '/uStore/default.aspx');
        home_link.setAttribute('id', 'logo_home_link');
        document.getElementById('logo').appendChild(home_link);
    </script>

    <%

    if ( this.isAdmin() )
    { %>

    <script>

        var dropBoxCats = [

		 <%

            List < Object[] > prodGroups = this.DBQuery("SELECT [ProductGroupID] ,[ParentGroupID],(SELECT COUNT(*) FROM [uStore].[dbo].[ProductGroup] AS pg2 WHERE pg2.StoreID = 144 AND pg2.StatusID = 1 AND pg2.ParentGroupID = [ProductGroup].[ProductGroupID]) AS children,[SEOContent_Culture].[Description] FROM [uStore].[dbo].[ProductGroup],[uStore].[dbo].[SEOContent], [uStore].[dbo].[SEOContent_Culture] WHERE StoreID = 144 AND StatusID = 1 AND CustomHeaderUrl = '/uStore/drop-box/grid.html' AND [SEOContent_Culture].[SEOContentID] = [SEOContent].[SEOContentID] AND [ProductGroupID] = EntityID");

        if (prodGroups.Count > 0) {
            bool isFirst = true;
            foreach(var prodGroup in prodGroups)
            {
                string delim = "";
                if (!isFirst)
                    delim = ",";

                int ProductGroupID = (int)prodGroup[0];
                int ParentGroupID = (int)prodGroup[1];
                int children = (int)prodGroup[2];
                string desc = (string)prodGroup[3];
				%><%=delim %>{ children:<%=children%>,ProductGroupID:<%=ProductGroupID%>,ParentGroupID:<%=ParentGroupID%>,desc: "<%=desc%>" } <%
                    isFirst = false;
            }
        }

		 %>

	 ];

        var isCoreCat = false;
        var isSuperAdmin = true;


        var parentGroupID;
        var dropBoxPath;
        var namePG = "";
        var newDropBoxPath;
        var ProductGroupID;

        function addCat() {
            namePG = $("[name='dropBoxCatNew']").val();

            if (namePG.trim() == "")
                alert("Please enter a name");
            else {
                dropBoxPath += "/" + namePG;

                LoadingTransparentDiv();
                addNewCat(dropBoxPath, parentGroupID, namePG
                    , function (response) {
                        RemoveWaitingDiv();

                        var re = /\<input type=\"hidden\" name=\"dbRedirectUrl\" value=\"(.*?)\" \/\>/i;
                        var found = response.match(re);

                        if (typeof (found) == "object" && found.length == 2) {
                            window.location.href = found[1];//$("[id='hdnMenuUrl']").val();
                        }
                        else {
                            window.location.reload();
                        }

                        //$("[name='hdnMenuUrl']").val("http://eezeeorder.com.au/uStore/144/Category/<%=newProductGroupID %>/<%=newProductDesc %>");
                        //window.location.reload();
                    });

            }
        }

        function renameCatContext() {
            namePG = $("[name='dropBoxCatRename']").val();

            if (namePG.trim() == "")
                alert("Please enter a name");
            else {
                newDropBoxPath += "/" + namePG;

                LoadingTransparentDiv();
                renameCat(dropBoxPath, newDropBoxPath, ProductGroupID, namePG
                    , function (response) {
                        RemoveWaitingDiv();
                        window.location.href = $("[id='hdnMenuUrl']").val();
                        //window.location.reload();
                    });
            }
        }



        function renameFileContext() {
            namePG = $("[name='dropBoxFileRename']").val();

            if (namePG.trim() == "")
                alert("Please enter a name");
            else {
                newDropBoxPath += namePG;
                console.log(dropBoxPath);
                console.log(newDropBoxPath);
                LoadingTransparentDiv();
                renameFile(dropBoxPath, newDropBoxPath, namePG
                    , function (response) {
                        RemoveWaitingDiv();
                        window.location.reload();
                    });
            }
        }

        function uploadFileContext() {

        }

        var pathParts;
        function findDropBoxPath(nodes, catId) {
            if (pathParts != null) return;

            $.each(nodes, function (i, node) {
                var catNo = $(node._element).find(".rtIn").first().attr("href").split("/")[4];

                if (catId == catNo) {
                    pathParts = new Array();
                    pathParts.push($(node._element).find(".rtIn").first().text());

                    while (typeof (node._parent) != "undefined" && node._parent != null && !$(node._parent._element).hasClass("RadTreeView")) {
                        pathParts.push($(node._parent._element).find(".rtIn").first().text());
                        node = node._parent;
                    }
                    pathParts.reverse();
                    return false;

                }

                if (node._children != null && node._children._array.length > 0)
                    findDropBoxPath(node._children._array, catId);
            });
        }

        function onlistGridDrawn() {
            if (!isCoreCat || isSuperAdmin) {

                var dialogRenameFile = $("#dropBoxRenameFileDlg").dialog({
                    autoOpen: false,
                    height: 400,
                    width: 350,
                    modal: true,
                    buttons: {
                        "Rename": renameFileContext,
                        Cancel: function () {
                            dialogRenameFile.dialog("close");
                        }
                    },
                    close: function () {

                    }
                });

                var dialog = $("#dropBoxDescAddDlg").dialog({
                    autoOpen: false,
                    height: 400,
                    width: 350,
                    modal: true,
                    buttons: {
                        "Add": addDesc,
                        Cancel: function () {
                            dialog.dialog("close");
                        }
                    },
                    close: function () {

                    }
                });

                var dialogUpdate = $("#dropBoxDescUpdateDlg").dialog({
                    autoOpen: false,
                    height: 400,
                    width: 350,
                    modal: true,
                    buttons: {
                        "Update": updateDesc,
                        Cancel: function () {
                            dialogUpdate.dialog("close");
                        }
                    },
                    close: function () {

                    }
                });

                $("#listGrid tbody tr").each(function (i, v) {
                    $.contextMenu({

                        selector: "a[href='" + $($(this).find("td")[1]).find("a").attr("href") + "']",
                        callback: function (key, options) {
                            if (key == "renameFile") {
                                dropBoxPath = options.$trigger.attr("href").split("&path=")[1];
                                var dropBoxPathParts = dropBoxPath.split("%2F");//console.log(dropBoxPathParts);
                                newDropBoxPath = "";
                                $.each(dropBoxPathParts, function (i, v) {
                                    if ((i + 1) != dropBoxPathParts.length) {
                                        newDropBoxPath += this + "%2F";
                                    }
                                });

                                namePG = "";
                                $("[name='dropBoxFileRename']").val(options.$trigger.text());
                                dialogRenameFile.dialog("open");
                            }
                            else if (key == "deleteFile") {
                                dropBoxPath = options.$trigger.attr("href").split("&path=")[1];
                                $("[id='hdnMenuUrl']").val(options.$trigger.attr("href"));
                                var path = window.location.href;
                                var str = path.split("/");
                                var len = str.length;
                                if (len - 2 >= 0) {
                                    ProductGroupID = str[len - 2];
                                }
                                var fileName = options.$trigger.text();


                                var r = confirm("Are you sure you want to remove this file?");
                                if (r == true) {
                                    LoadingTransparentDiv();
                                    deleteFile(dropBoxPath, fileName, ProductGroupID
                                        , function (response) {
                                            RemoveWaitingDiv();
                                            //window.location.href= $("[id='hdnMenuUrl']").val();
                                            window.location.reload();
                                        });
                                }
                            }

                        },
                        items: {
                            "renameFile": { name: "Rename", icon: "edit" },
                            "deleteFile": { name: "Delete", icon: "delete" }

                        }
                    });
                });

                function addDesc() {
                    currFileDesc = $("[name='dropBoxDesc']").val().trim();

                    if (currFileDesc == "") {
                        alert("Please enter a description");
                    }
                    else {
                        addDropBoxDesc(currFileName, currCatId, currFileDesc, function (data) {
                            window.location.reload();
                        });
                    }
                }

                function updateDesc() {
                    currFileDesc = $("[name='dropBoxDescUpdate']").val().trim();

                    if (currFileDesc == "") {
                        alert("Please enter a description");
                    }
                    else {
                        updateDropBoxFileDesc(currFileName, currCatId, currFileDesc, currDropBoxFileDescId, function (data) {
                            window.location.reload();
                        });
                    }
                }

                if (!isCoreCat || isSuperAdmin) {
                    var dropBoxDescOptsAdd = '<div class="dropBoxDescOpts"><a href="#" class="dropBoxDescAdd">Add Description</a></div>';
                    var dropBoxDescOptsAlter = '<div class="dropBoxDescOpts"><a href="#" class="dropBoxDescUpdate">Update Description</a><br><a href="#" class="dropBoxDescRemove">Remove Description</a></div>';
                    $("#listGrid tbody").find("tr[role='row']").each(function (i, v) {
                        if ($(this).find("td").last().find(".dropBoxFileDescId").length > 0) {
                            $(this).find("td").last().append(dropBoxDescOptsAlter);
                        }
                        else {
                            $(this).find("td").last().append(dropBoxDescOptsAdd);
                        }

                    });
                }

                var currDropBoxFileDescId = "";
                var currFileName = "";
                var currCatId = "";
                var currFileDesc = "";

                var urlParts = window.location.href.split("/");

                $.each(urlParts, function (i, urlPart) {
                    if (urlPart == "Category") {
                        currCatId = urlParts[i + 1];
                    }
                });

                $(".dropBoxDescAdd").click(function (e) {
                    e.preventDefault();

                    currFileName = $(this).closest("td").prev().find("a").text();

                    dialog.dialog("open");
                });

                $(".dropBoxDescUpdate").click(function (e) {
                    e.preventDefault();

                    currFileName = $(this).closest("td").prev().find("a").text();
                    currDropBoxFileDescId = $(this).closest("td").find(".dropBoxFileDescId").attr("id").replace("dropBoxFileDescId-", "");

                    $("[name='dropBoxDescUpdate']").val($(this).closest("td").find(".dropBoxFileDescId").text());

                    dialogUpdate.dialog("open");
                });

                $(".dropBoxDescRemove").click(function (e) {
                    e.preventDefault();

                    currDropBoxFileDescId = $(this).closest("td").find(".dropBoxFileDescId").attr("id").replace("dropBoxFileDescId-", "");

                    var r = confirm("Are you sure you want to remove this description?");
                    if (r == true) {
                        removeDropBoxDesc(currDropBoxFileDescId, function (data) {
                            window.location.reload();
                        });
                    }
                });

            }

        }

        function addDropBoxDesc(_fileName, _catId, _fileDesc, callback) {
            $.post(window.location.href,
                {
                    operation: "addDropBocFileDesc", fileName: _fileName,
                    catId: _catId, fileDesc: _fileDesc

                })
                .done(function (data) {
                    callback(data);
                });
        }

        function updateDropBoxFileDesc(_fileName, _catId, _fileDesc, _dropBoxFileDescId, callback) {
            $.post(window.location.href,
                {
                    operation: "updateDropBoxFileDesc", fileName: _fileName,
                    catId: _catId, fileDesc: _fileDesc,
                    dropBoxFileDescId: _dropBoxFileDescId

                })
                .done(function (data) {
                    callback(data);
                });
        }

        function removeDropBoxDesc(_dropBoxFileDescId, callback) {
            $.post(window.location.href,
                {
                    operation: "removeDropBoxDesc", dropBoxFileDescId: _dropBoxFileDescId
                })
                .done(function (data) {
                    callback(data);
                });
        }

        function addNewCat(_dropBoxPath, _ParentGroupID, _NamePG, callback) {
            $.post(window.location.href,
                {
                    operation: "addNewCat", dropBoxPath: _dropBoxPath
                    , ParentGroupID: _ParentGroupID
                    , NamePG: _NamePG
                })
                .done(function (data) {
                    callback(data);
                });
        }

        function renameCat(_dropBoxPath, _newDropBoxPath, _ProductGroupID, _NamePG, callback) {
            // alert(_dropBoxPath + " " + _newDropBoxPath);
            $.post(window.location.href,
                {
                    operation: "renameCat"
                    , dropBoxPath: _dropBoxPath
                    , newDropBoxPath: _newDropBoxPath
                    , ProductGroupID: _ProductGroupID
                    , NamePG: _NamePG
                })
                .done(function (data) {
                    callback(data);
                });
        }

        function renameFile(_dropBoxPath, _newDropBoxPath, _NamePG, callback) {
            $.post(window.location.href,
                {
                    operation: "renameFile"
                    , dropBoxPath: _dropBoxPath
                    , newDropBoxPath: _newDropBoxPath
                    , NamePG: _NamePG
                })
                .done(function (data) {
                    callback(data);
                });
        }

        function removeCat(_dropBoxPath, _ProductGroupID, _parentUrl, callback) {
            $.post(window.location.href,
                {
                    operation: "removeCat"
                    , dropBoxPath: _dropBoxPath
                    , ProductGroupID: _ProductGroupID
                    , parentUrl: _parentUrl
                })
                .done(function (data) {

                    callback(data);
                });
        }

        function deleteFile(_dropBoxPath, _fileName, _ProductGroupID, callback) {
            $.post(window.location.href,
                {
                    operation: "deleteFile"
                    , dropBoxPath: _dropBoxPath
                    , ProductGroupID: _ProductGroupID
                    , FileName: _fileName
                })
                .done(function (data) {
                    callback(data);
                });
        }

        $(document).ready(function () {


		 <% if(!this.isSuperAdmin()) { %>

                isCoreCat = false;
                isSuperAdmin = false;
                var urlParts = window.location.href.split("/");
                if (urlParts.length >= 7) {
                    if (urlParts[5] == "Category") {
                        var currCatId = urlParts[6];

                        var catTree = [

						 <%

                            List < Object[] > prodGroupsCatTree = this.DBQuery("SELECT [ProductGroupID],[ParentGroupID] FROM [uStore].[dbo].[ProductGroup] WHERE StoreID = 144 AND StatusID = 1 AND ParentGroupID IS NOT NULL");

                        if (prodGroupsCatTree.Count > 0) {
                            bool isFirst = true;
                            foreach(var prodGroup in prodGroupsCatTree)
        {
            string delim = "";
            if (!isFirst)
                delim = ",";

            int ProductGroupID = (int)prodGroup[0];
            int ParentGroupID = (int)prodGroup[1];
								%><%=delim %>{ ProductGroupID:<%=ProductGroupID%>,ParentGroupID:<%=ParentGroupID%>}<%
                isFirst = false;
        }
						}

						 %>

					 ];

        var hasParent = true;
        var parentCat = currCatId;

        while (hasParent) {
            var parentFound = false;
            $.each(catTree, function (i, row) {
                if (row.ProductGroupID == parentCat) {
                    parentCat = row.ParentGroupID;
                    parentFound = true;
                }
            });

            hasParent = parentFound;

            if (parentCat == 1834)
                isCoreCat = true;
        }


				}
			}

        if (isCoreCat) {
            $("input[value='Upload File']").hide();
        }

		 <% } %>

		// alert(window.location.href + " new: " + $("[id='hdnMenuUrl']").val());
		 var dialogAddCat = $("#dropBoxCatAddDlg").dialog({
            autoOpen: false,
            height: 400,
            width: 350,
            modal: true,
            buttons: {
                "Add": addCat,
                Cancel: function () {
                    dialogAddCat.dialog("close");
                }
            },
            close: function () {

            }
        });

        var dialogRenameCat = $("#dropBoxCatRenameDlg").dialog({
            autoOpen: false,
            height: 400,
            width: 350,
            modal: true,
            buttons: {
                "Rename": renameCatContext,
                Cancel: function () {
                    dialogRenameCat.dialog("close");
                }
            },
            close: function () {

            }
        });

        var dialogUpload = $("#dropBoxUploadDlg").dialog({
            autoOpen: false,
            height: 300,
            width: 560,
            modal: true,
            buttons: {
                Close: function () {
                    dialogUpload.dialog("close");
                }
            },
            close: function () {
                window.location.reload();
            }
        });

        var allItems = {
            "renameFolder": { name: "Rename", icon: "edit" },
            "deleteFolder": { name: "Delete", icon: "delete" },
            "sep1": "---------",
            "uploadFile": { name: "Upload File", icon: "copy" }
            , "addFolder": { name: "Add Folder", icon: "add" }
        };

        var allItemsNoDelete = {
            "renameFolder": { name: "Rename", icon: "edit" },
            "sep1": "---------",
            "uploadFile": { name: "Upload File", icon: "copy" }
            , "addFolder": { name: "Add Folder", icon: "add" }
        };

        var limitedItems = {
            "addFolder": { name: "Add Folder", icon: "add" }
        };



        $(".rtIn").each(function (i, v) {
			 <% if(!this.isSuperAdmin()) { %>
				 if($(this).closest(".rtFirst").length > 0)
                    return;
			 <% } %>

			 var validOpts = limitedItems;
            var currProductGroupID = $(this).attr("href").split("/")[4];

            var rtIn = this;

            $.each(dropBoxCats, function (b, n) {
                if (this.ProductGroupID == currProductGroupID) {
                    validOpts = allItems;

                    if ($(rtIn).prev().hasClass("rtMinus") || $(rtIn).prev().hasClass("rtPlus"))
                        validOpts = allItemsNoDelete;


                    //if(this.children > 0)
                    //validOpts = allItemsNoDelete;

                    return false;
                }
            });

            $.contextMenu({
                selector: ".rtIn[href='" + $(this).attr("href") + "']",
                callback: function (key, options) {
                    if (key == "addFolder") {
                        parentGroupID = options.$trigger.attr("href").split("/")[4];
                        var count = document.getElementById('');
                      
                        var url = options.$trigger.attr("href");

                        $("[id='hdnMenuUrl']").val(url);

                        pathParts = null;
                        if (radTree()._children == null) {
                            $(".rtPlus").first().click();
                            $(".rtMinus").first().click();
                        }

                        findDropBoxPath(radTree()._children._array, parentGroupID);

                        if (pathParts != null) {
                            dropBoxPath = "/NSWBC Portal Downloads";

                            $.each(pathParts, function (i, v) {
                                dropBoxPath += "/" + this;
                            });

                            namePG = "";
                            $("[name='dropBoxCatNew']").val("");
                            dialogAddCat.dialog("open");
                        }
                    }
                    else if (key == "renameFolder") {
                        ProductGroupID = options.$trigger.attr("href").split("/")[4];
                        pathParts = null;
                        if (radTree()._children == null) {
                            $(".rtPlus").first().click();
                            $(".rtMinus").first().click();
                        }

                        findDropBoxPath(radTree()._children._array, ProductGroupID);

                        if (pathParts != null) {
                            dropBoxPath = "/NSWBC Portal Downloads";
                            newDropBoxPath = dropBoxPath;

                            $.each(pathParts, function (i, v) {
                                dropBoxPath += "/" + this;

                                if ((i + 1) < pathParts.length)
                                    newDropBoxPath += "/" + this;
                            });
                            dropBoxPath += "/";
                            namePG = "";
                            $("[name='dropBoxCatRename']").val("");
                            dialogRenameCat.dialog("open");
                        }
                    }
                    else if (key == "deleteFolder") {
                        var parentUrl = options.$trigger.closest(".rtUL").prev("div").find("a").attr("href");
                        ProductGroupID = options.$trigger.attr("href").split("/")[4];
                        var url = options.$trigger.attr("href");
                        pathParts = null;
                        $("[id='hdnMenuUrl']").val(url);
                        if (radTree()._children == null) {
                            $(".rtPlus").first().click();
                            $(".rtMinus").first().click();
                        }

                        findDropBoxPath(radTree()._children._array, ProductGroupID);

                        if (pathParts != null) {
                            dropBoxPath = "/NSWBC Portal Downloads";

                            $.each(pathParts, function (i, v) {
                                dropBoxPath += "/" + this;
                            });

                            var r = confirm("Are you sure you want to remove this folder?");
                            if (r == true) {
                                LoadingTransparentDiv();

                                removeCat(dropBoxPath, ProductGroupID, parentUrl
                                    , function (response) {
                                        RemoveWaitingDiv();
                                        window.location.href = parentUrl;

                                    });
                            }
                        }
                    }
                    else if (key == "uploadFile") {
                        ProductGroupID = options.$trigger.attr("href").split("/")[4];
                        pathParts = null;
                        if (radTree()._children == null) {
                            $(".rtPlus").first().click();
                            $(".rtMinus").first().click();
                        }

                        findDropBoxPath(radTree()._children._array, ProductGroupID);

                        if (pathParts != null) {
                            dropBoxPath = "/NSWBC Portal Downloads";

                            $.each(pathParts, function (i, v) {
                                dropBoxPath += "/" + this;
                            });

                            //add src to iframe dlg
                            $("#dropBoxUploadDlg iframe").attr("src", "http://glmcampaign.com.au/drop-box-php/upload-form-from-path-multi.php?path=" + dropBoxPath);
                            dialogUpload.dialog("open");
                        }
                    }

                },
                items: validOpts
            });
        });


	 } );

        function UploadFile() {
            var dialogUpload = $("#dropBoxUploadDlg").dialog({
                autoOpen: false,
                height: 300,
                width: 560,
                modal: true,
                buttons: {
                    Close: function () {
                        dialogUpload.dialog("close");
                    }
                },
                close: function () {
                    window.location.reload();
                }
            });

            var path = window.location.href;
            var str = path.split("/");
            var len = str.length;
            if (len - 2 >= 0) {
                ProductGroupID = str[len - 2];

                pathParts = null;
                if (radTree()._children == null) {
                    $(".rtPlus").first().click();
                    $(".rtMinus").first().click();
                }

                findDropBoxPath(radTree()._children._array, ProductGroupID);

                if (pathParts != null) {
                    dropBoxPath = "/NSWBC Portal Downloads";

                    $.each(pathParts, function (i, v) {
                        dropBoxPath += "/" + this;
                    });

                    //add src to iframe dlg
                    $("#dropBoxUploadDlg iframe").attr("src", "http://glmcampaign.com.au/drop-box-php/upload-form-from-path-multi.php?path=" + dropBoxPath);
                    dialogUpload.dialog("open");
                }
            }
        }

    </script>
    <div style="display:none;">
        <div id="dropBoxDescAddDlg" title="Add Description">

            <form>
                <fieldset>
                    <label for="Description">Description</label>
                    <textarea style="width: 303px;height: 267px;" name="dropBoxDesc" class="text ui-widget-content ui-corner-all" maxlength="250"></textarea>

                    <!-- Allow form submission with keyboard without duplicating the dialog button -->
                    <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                </fieldset>
            </form>
        </div>
        <div id="dropBoxDescUpdateDlg" title="Update Description">

            <form>
                <fieldset>
                    <label for="Description">Description</label>
                    <textarea style="width: 303px;height: 267px;" name="dropBoxDescUpdate" class="text ui-widget-content ui-corner-all" maxlength="250"></textarea>

                    <!-- Allow form submission with keyboard without duplicating the dialog button -->
                    <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                </fieldset>
            </form>
        </div>

        <div id="dropBoxCatAddDlg" style="height:37px;" title="Add Folder">
            <form>
                <fieldset>
                    <label for="dropBoxCatNew">Name:</label>
                    <input name="dropBoxCatNew" class="text ui-widget-content ui-corner-all" maxlength="30" title="Maxlength of 30"></textarea>

                    <!-- Allow form submission with keyboard without duplicating the dialog button -->
                    <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                </fieldset>
            </form>
        </div>

        <div id="dropBoxCatRenameDlg" title="Rename Folder">
            <form>
                <fieldset>
                    <label for="dropBoxCatRename">Name:</label>
                    <input name="dropBoxCatRename" class="text ui-widget-content ui-corner-all" maxlength="30" title="Maxlength of 30"></textarea>

                    <!-- Allow form submission with keyboard without duplicating the dialog button -->
                    <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                </fieldset>
            </form>
        </div>

        <div id="dropBoxUploadDlg" title="Upload File">
            <iframe src="" style="border:none;width: 530px;"></iframe>
        </div>

        <div id="dropBoxRenameFileDlg" title="Rename File">
            <form>
                <fieldset>
                    <label for="dropBoxFileRename">Name:</label>
                    <input name="dropBoxFileRename" class="text ui-widget-content ui-corner-all" maxlength="30" title="Maxlength of 30"></textarea>

                    <!-- Allow form submission with keyboard without duplicating the dialog button -->
                    <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                </fieldset>
            </form>
        </div>

    </div>

    <% } else { %>
    <script>
        $(document).ready(function () {
            $("input[value='Upload File']").hide();
        });
    </script>
    <% }

    if ( this.isAdmin() )
    { %>
    <script src="<%= StoreStylePath %>jq-context-menu/jquery.contextMenu.min.js" type="text/javascript"></script>
    <script src="<%= StoreStylePath %>jq-context-menu/jquery.ui.position.min.js" type="text/javascript"></script>
    <% }

    if ( this.isSearchPage ){ %>
    <script>

        $(window).load(function () {
            LoadingTransparentDiv();

            var query = window.location.href.split("/").pop();

            dropBoxSearch(query
                , function (data) {
                    data = $.parseJSON(data);

                    if (typeof (data.respone) != "undefined") {
                        if (data.respone == "1") {
                            if (typeof (data.data) != "undefined" && data.data.length > 0) {
                                $.each(data.data, function (i, record) {
                                    var path = record.path;

                                    var pathParts = path.split("/");
                                    pathParts.pop();

                                    path = pathParts.join("/");

                                    var rtULCats = $(".rtUL").first();

                                    var indent = "";

                                    var hasPermission = false;

                                    iterateCats(rtULCats, path, "");
                                    function iterateCats(root, path, indent) {
                                        root.children("li").each(function (i, li) {
                                            var curCat = $(this).children("div").first().children("a").attr("href").split("/")[4];

                                            $.each(dropBoxCats, function (i, cat) {
                                                if (unescape(cat.desc).toLowerCase()
                                                    == path.toLowerCase()
                                                    && curCat == cat.ProductGroupID) {
                                                    hasPermission = true;
                                                }
                                            });

                                            if (!hasPermission && $(this).children(".rtUL").length > 0)
                                                iterateCats($(this).children(".rtUL"), path, indent + "-");
                                        });
                                    }

                                    if (hasPermission) {
                                        var prodLink = record.downloadLnk;
                                        var thumbLink = record.thumb;
                                        var prodDesc = record.fileName;
                                        var previewLnk = record.preview;

                                        var serpRecHtml = '<tr><td><div class="productlistview productListTable floatClearing"><div class="thumbnail"><a href="' + previewLnk + '" class="previewLnk" style="text-align: left;"><img src="' + thumbLink + '" border="0" alt="" class="ProductListImage"></a></div><div class="productInfo"><div class="productname"><a href="' + prodLink + '"><span>' + prodDesc + '</span></a></div><div class="productdesc"><a href="' + prodLink + '"><span></span></a></div></div><div class="pricingInfo"><div class="productDetailsLink"><a class=" btn btn-default XmpImageButton XmpieThemeColorButton" href="' + prodLink + '">Download &gt;</a></div></div></div></td></tr>';
                                        $("#result").append(serpRecHtml);
                                        $("#ctl00_cphMainContent_lblNoResults").hide();
                                    }


                                });

                                $(".previewLnk").click(function (e) {
                                    e.preventDefault();
                                    var previewLink = $(this).attr("href");
                                    window.open(previewLink, "", "width=655,height=602");
                                });
                            }
                        }
                    }

                    RemoveWaitingDiv();
                });
        });

        function dropBoxSearch(_query, callback) {
            $.get("http://glmcampaign.com.au/drop-box-php/search.php",
                {
                    path: "/NSWBC%20Portal%20Downloads"
                    , filesOnly: "1"
                    , downloadFiles: "1"
                    , tk: "d098lkLKHJg903kjh3liO78Go2s0987sgd8gq1IUY21kI9g"
                    , query: _query
                })
                .done(function (data) {
                    callback(data);
                });
        }

    </script>
    <% } %>


    <input type="hidden" name="dbRedirectUrl" value="<%=dbRedirectUrl%>" />
</body>
</html>
